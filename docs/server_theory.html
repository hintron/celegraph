<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>How Celegraph works - high level · Celegraph</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="How Celegraph works - high level · Celegraph"/><meta property="og:type" content="website"/><meta property="og:url" content="https://hintron.github.io/celegraph/index.html"/><meta property="og:description" content="Currently, there is a single central server that manages everything. All messages between clients are routed through this server."/><meta property="og:image" content="https://hintron.github.io/celegraph/img/celegraph_halo_filled.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://hintron.github.io/celegraph/img/celegraph_halo_filled.png"/><link rel="shortcut icon" href="/celegraph/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://hintron.github.io/blog/atom.xml" title="Celegraph Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://hintron.github.io/blog/feed.xml" title="Celegraph Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/celegraph/css/main.css"/></head><body class="sideNavVisible doc separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/celegraph/"><img class="logo" src="/celegraph/img/celegraph_halo.svg" alt="Celegraph"/><h2 class="headerTitleWithLogo">Celegraph</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/celegraph/docs/usage.html" target="_self">Docs</a></li><li class=""><a href="/celegraph/blog" target="_self">Blog</a></li><li class=""><a href="https://github.com/hintron/celegraph" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Docs</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>Docs</h3><ul><li class="navListItem"><a class="navItem" href="/celegraph/docs/usage.html">Server and Test Client Usage</a></li><li class="navListItem"><a class="navItem" href="/celegraph/docs/requirements.html">Requirements</a></li><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/celegraph/docs/server_theory.html">How Celegraph works - high level</a></li><li class="navListItem"><a class="navItem" href="/celegraph/docs/docker.html">How To Use Docker</a></li><li class="navListItem"><a class="navItem" href="/celegraph/docs/todo.html">Project TODO</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>How Celegraph works - high level</h1></header><article><div><span><p>Currently, there is a single central server that manages everything. All messages between clients are routed through this server.</p>
<p>The server creates a pool of worker threads that each can process a single packet at a time. The main thread listens for packets and forwards those packets to the worker threads via a single packet queue.</p>
<h2><a class="anchor" aria-hidden="true" id="how-celegraph-works-more-details"></a><a href="#how-celegraph-works-more-details" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How Celegraph works - more details:</h2>
<p>When the server first starts (see <code>Server::Run()</code> in Server.cpp), the main thread spawns an admin shell thread:</p>
<pre><code class="hljs">main
|<span class="hljs-string">       admin shell
</span>|<span class="hljs-string">-------^
</span>|<span class="hljs-string">       </span>|
</code></pre>
<p>This shell provides administrative CLI access to the server itself during operation (see AdminShell.cpp). It just loops, waiting for input from the command line.</p>
<p>Once the admin shell thread has been created, the main thread (i.e. <code>Server::Run()</code>) will then create worker threads (see <code>Server::WorkerThread()</code> in Server.cpp):</p>
<pre><code class="hljs">main
|<span class="hljs-string">       admin shell
</span>|<span class="hljs-string">-------^
</span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">     wrk1    wrk2    wrk3    wrk4
</span>|<span class="hljs-string">---------------^-------^-------^-------^
</span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|
</code></pre>
<p>The main thread then enters an infinite loop to listen for UDP packets coming on the port specified for the socket.</p>
<p>The main thread and the worker threads all share the same packet queue. This packet queue is essentially a message queue that the main thread uses to communicate with the worker threads.</p>
<pre><code class="hljs">main                           -------------
|<span class="hljs-string">       admin shell     queue: </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|
|<span class="hljs-string">-------^                      -------------
</span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">     wrk1    wrk2    wrk3    wrk4
</span>|<span class="hljs-string">---------------^-------^-------^-------^
</span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|
</code></pre>
<p>When a packet comes in, the main thread takes a mutex lock, so that it knows nobody else is touching the packet queue. Then, it copies the received packet into the packet queue, released the lock, and notifies the other threads that there is something in the packet queue. It does this by calling the <code>notify_one()</code> method of something called a std::condition_variable. Then, it loops back to the top to listen for packets again.</p>
<pre><code class="hljs">main                           -------------
|<span class="hljs-string">       admin shell     queue: </span>|<span class="hljs-string">o</span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|
|<span class="hljs-string">-------^                      -------------
</span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">     wrk1    wrk2    wrk3    wrk4
</span>|<span class="hljs-string">---------------^-------^-------^-------^
</span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|
</code></pre>
<p>The worker threads also try to take the mutex lock. But it does this by wrapping it in something special called a std::unique_lock. Creating a unique_lock with the mutex automatically takes out a lock on the mutex it wraps.</p>
<p>Then, the worker thread will wait on the condition_variable shared with main via the method <code>wait()</code>. <code>wait()</code> will release the mutex wrapped by unique_lock, put the worker thread to sleep, and wait until the main thread wakes it up via the <code>notify_one()</code> command.</p>
<p>When the worker thread wakes, it automatically retakes the mutex and has the green light to pull a packet out of the packet queue. Once the worker thread creates a local copy of the packet to work with, it releases the lock, and the packet queue is free to be used. If multiple threads are waiting, only one of them will get woken up by the <code>notify_one()</code> command.</p>
<pre><code class="hljs">main                           -------------
|<span class="hljs-string">       admin shell     queue: </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|<span class="hljs-string"> </span>|
|<span class="hljs-string">-------^                      -------------
</span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">     wrk1    wrk2    wrk3    wrk4
</span>|<span class="hljs-string">---------------^-------^-------^-------^
</span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       o       </span>|<span class="hljs-string">       </span>|
|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|<span class="hljs-string">       </span>|
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="requirements.html">← Requirements</a><a class="docs-next button" href="docker.html">How To Use Docker →</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#how-celegraph-works-more-details">How Celegraph works - more details:</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/celegraph/" class="nav-home"><img src="/celegraph/img/celegraph_halo.svg" alt="Celegraph" width="66" height="58"/></a><div><h5>Docs</h5><a href="/celegraph/docs/en/doc1.html">Getting Started (or other categories)</a><a href="/celegraph/docs/en/doc2.html">Guides (or other categories)</a><a href="/celegraph/docs/en/doc3.html">API Reference (or other categories)</a></div><div><h5>Community</h5><a href="/celegraph/en/users.html">User Showcase</a><a href="http://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://discordapp.com/">Project Chat</a><a href="https://twitter.com/" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/celegraph/blog">Blog</a><a href="https://github.com/hintron/celegraph">GitHub</a><a class="github-button" href="https://github.com/hintron/celegraph" data-icon="octicon-star" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2018 Michael Hinton</section></footer></div></body></html>